<!DOCTYPE html>
<html><head><title>Hash Test</title></head>
<body style="font-family:monospace;background:#111;color:#eee;padding:2em;">
<h2>URL Hash Diagnostic</h2>
<div id="output"></div>
<script>
const out = document.getElementById('output');
function log(msg) { out.innerHTML += msg + '<br>'; }

const hash = window.location.hash;
log(`Hash present: ${!!hash}`);
log(`Hash length: ${hash.length}`);
log(`Starts with #results=: ${hash.startsWith('#results=')}`);

if (hash.startsWith('#results=')) {
    const raw = hash.substring('#results='.length);
    log(`Raw base64 length: ${raw.length}`);
    log(`First 80 chars: ${raw.substring(0, 80)}`);
    log(`Last 20 chars: ${raw.substring(raw.length - 20)}`);

    try {
        let base64 = raw.replace(/-/g, '+').replace(/_/g, '/');
        const pad = (4 - (base64.length % 4)) % 4;
        if (pad > 0) base64 += '='.repeat(pad);
        log(`After restore: length=${base64.length}, pad added=${pad}`);

        const json = atob(base64);
        log(`Decoded JSON length: ${json.length}`);

        const data = JSON.parse(json);
        log(`Parsed OK. results count: ${data.results?.length ?? 'N/A'}`);
        log(`Machine: ${data.machineName || 'N/A'}`);

        if (data.results) {
            for (const r of data.results) {
                log(`  ${r.id} | ${r.status} | ${r.resultValue?.substring(0,60) || ''}`);
            }
        }
        log('<br><strong style="color:#4f4">SUCCESS - Import data is valid!</strong>');
    } catch (e) {
        log(`<strong style="color:#f44">ERROR: ${e.message}</strong>`);
        log(`Stack: ${e.stack}`);
    }
} else if (hash) {
    log(`Hash content (first 200): ${hash.substring(0, 200)}`);
} else {
    log('<strong style="color:#fa0">No hash in URL - the scanner data was not passed!</strong>');
    log('This means either:');
    log('1. Windows truncated the URL when opening the browser');
    log('2. The browser stripped the hash on navigation');
    log('3. The page was already open and reused (no fresh load)');
}

// Also listen for hashchange in case browser navigates after load
window.addEventListener('hashchange', () => {
    log('<br><strong>--- hashchange event fired ---</strong>');
    log(`New hash length: ${window.location.hash.length}`);
});
</script>
</body>
</html>
