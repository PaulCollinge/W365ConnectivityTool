<Window x:Class="W365ConnectivityTool.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:W365ConnectivityTool.ViewModels"
        xmlns:conv="clr-namespace:W365ConnectivityTool.Converters"
        xmlns:views="clr-namespace:W365ConnectivityTool.Views"
        Title="Windows 365 / AVD Connectivity Diagnostics"
        Width="900" Height="750" MinWidth="700" MinHeight="500"
        WindowStartupLocation="CenterScreen"
        Background="#F3F3F3">

    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="Resources/Styles.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <conv:StatusToColorConverter x:Key="StatusToColor"/>
            <conv:BoolToVisibilityConverter x:Key="BoolToVis"/>
            <conv:InverseBoolConverter x:Key="InverseBool"/>
            <conv:StringToVisibilityConverter x:Key="StringToVis"/>
            <conv:StatusToBackgroundConverter x:Key="StatusToBackground"/>
            <conv:StatusToForegroundConverter x:Key="StatusToForeground"/>
        </ResourceDictionary>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="#0078D4" Padding="24,16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0">
                    <TextBlock Text="Windows 365 / AVD Connectivity Diagnostics"
                               FontSize="20" FontWeight="SemiBold" Foreground="White"/>
                    <TextBlock Text="Network Path Analysis &amp; Troubleshooting Tool"
                               FontSize="12" Foreground="#B4D6FA" Margin="0,4,0,0"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="▶  Run All Tests"
                            Command="{Binding RunAllTestsCommand}"
                            Style="{StaticResource PrimaryButton}"
                            Background="White" Foreground="#0078D4"
                            Margin="0,0,8,0"/>
                    <Button Content="■  Cancel"
                            Command="{Binding CancelCommand}"
                            Style="{StaticResource SecondaryButton}"
                            BorderBrush="White" Foreground="White"
                            Visibility="{Binding IsRunning, Converter={StaticResource BoolToVis}}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Progress Bar -->
        <ProgressBar Grid.Row="1" Height="4"
                     Minimum="0" Maximum="{Binding TotalTests}"
                     Value="{Binding Progress}"
                     Style="{StaticResource ModernProgressBar}"
                     Visibility="{Binding IsRunning, Converter={StaticResource BoolToVis}}"/>

        <!-- Summary Bar -->
        <Border Grid.Row="2" Background="White" BorderBrush="#E1DFDD" BorderThickness="0,0,0,1" Padding="24,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="{Binding StatusText}" FontSize="12" Foreground="#605E5C"
                               VerticalAlignment="Center"/>
                    <TextBlock Text="  │  " Foreground="#E1DFDD" VerticalAlignment="Center"
                               Visibility="{Binding SummaryText, Converter={StaticResource StringToVis}}"/>
                    <TextBlock Text="{Binding SummaryText}" FontSize="12" FontWeight="SemiBold"
                               Foreground="#323130" VerticalAlignment="Center"
                               Visibility="{Binding SummaryText, Converter={StaticResource StringToVis}}"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="📋 Copy" Command="{Binding CopyResultsCommand}"
                            Style="{StaticResource SecondaryButton}" Margin="0,0,6,0"/>
                    <Button Content="📄 Export Text" Command="{Binding ExportTextCommand}"
                            Style="{StaticResource SecondaryButton}" Margin="0,0,6,0"/>
                    <Button Content="📊 Export JSON" Command="{Binding ExportJsonCommand}"
                            Style="{StaticResource SecondaryButton}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Connectivity Map -->
        <views:ConnectivityMapControl x:Name="ConnectivityMap" Grid.Row="3" Margin="24,12,24,0"/>

        <!-- Test Results -->
        <ScrollViewer Grid.Row="4" VerticalScrollBarVisibility="Auto" Padding="24,16">
            <StackPanel>
                <!-- Standard Connectivity Tests -->
                <ItemsControl ItemsSource="{Binding Categories}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type vm:TestCategoryGroup}">
                        <Border Margin="0,0,0,16">
                            <Expander IsExpanded="{Binding IsExpanded}" Style="{StaticResource CategoryExpander}">
                                <Expander.Header>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{Binding Icon}" FontSize="16" Margin="0,0,8,0"
                                                   VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding Name}" FontSize="15" FontWeight="SemiBold"
                                                   Foreground="#323130" VerticalAlignment="Center"/>
                                        <TextBlock Text="  —  " Foreground="#8A8886" VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding Summary}" FontSize="12" FontWeight="Normal"
                                                   Foreground="#605E5C" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Expander.Header>

                                <ItemsControl ItemsSource="{Binding Tests}" Margin="0,8,0,0">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate DataType="{x:Type vm:TestResultViewModel}">
                                            <Border Style="{StaticResource CardBorder}" Margin="0,0,0,6">
                                                <StackPanel>
                                                    <!-- Main Row -->
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="36"/>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                        </Grid.ColumnDefinitions>

                                                        <!-- Status Icon -->
                                                        <Border Grid.Column="0" Width="28" Height="28"
                                                                CornerRadius="14"
                                                                Background="{Binding Status, Converter={StaticResource StatusToBackground}}"
                                                                HorizontalAlignment="Center" VerticalAlignment="Center">
                                                            <TextBlock Text="{Binding StatusIcon}"
                                                                       FontSize="14" FontWeight="Bold"
                                                                       Foreground="{Binding Status, Converter={StaticResource StatusToForeground}}"
                                                                       HorizontalAlignment="Center"
                                                                       VerticalAlignment="Center"/>
                                                        </Border>

                                                        <!-- Test Name -->
                                                        <StackPanel Grid.Column="1" Margin="8,0,16,0"
                                                                    VerticalAlignment="Center">
                                                            <StackPanel Orientation="Horizontal">
                                                                <TextBlock Text="{Binding Name}" FontSize="13"
                                                                           FontWeight="SemiBold" Foreground="#323130"/>
                                                                <TextBlock Text="{Binding Duration}" FontSize="11"
                                                                           Foreground="#8A8886" Margin="8,2,0,0"
                                                                           Visibility="{Binding Duration, Converter={StaticResource StringToVis}}"/>
                                                            </StackPanel>
                                                        </StackPanel>

                                                        <!-- Result Value -->
                                                        <TextBlock Grid.Column="2" Text="{Binding ResultValue}"
                                                                   FontSize="12" Foreground="#605E5C"
                                                                   VerticalAlignment="Center" Margin="0,0,12,0"/>

                                                        <!-- Expand Toggle -->
                                                        <ToggleButton Grid.Column="3"
                                                                      IsChecked="{Binding IsExpanded}"
                                                                      Width="24" Height="24" Cursor="Hand"
                                                                      VerticalAlignment="Center">
                                                            <ToggleButton.Template>
                                                                <ControlTemplate TargetType="ToggleButton">
                                                                    <Border Background="Transparent">
                                                                        <TextBlock x:Name="Arrow" Text="▸"
                                                                                   FontSize="12" Foreground="#8A8886"
                                                                                   HorizontalAlignment="Center"
                                                                                   VerticalAlignment="Center"/>
                                                                    </Border>
                                                                    <ControlTemplate.Triggers>
                                                                        <Trigger Property="IsChecked" Value="True">
                                                                            <Setter TargetName="Arrow" Property="Text" Value="▾"/>
                                                                        </Trigger>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter TargetName="Arrow" Property="Foreground"
                                                                                    Value="{StaticResource MicrosoftBlueBrush}"/>
                                                                        </Trigger>
                                                                    </ControlTemplate.Triggers>
                                                                </ControlTemplate>
                                                            </ToggleButton.Template>
                                                        </ToggleButton>
                                                    </Grid>

                                                    <!-- Expandable Details -->
                                                    <StackPanel Visibility="{Binding IsExpanded, Converter={StaticResource BoolToVis}}"
                                                                Margin="36,8,0,0">

                                                        <!-- Description -->
                                                        <TextBlock Text="{Binding Description}" FontSize="12"
                                                                   Foreground="#605E5C" TextWrapping="Wrap"
                                                                   Margin="8,0,0,8"/>

                                                        <!-- Detailed Info -->
                                                        <Border Background="#F9F9F9" CornerRadius="4" Padding="12,8"
                                                                Margin="8,0,0,8"
                                                                Visibility="{Binding HasDetails, Converter={StaticResource BoolToVis}}">
                                                            <TextBlock Text="{Binding DetailedInfo}" FontSize="11"
                                                                       FontFamily="Consolas" Foreground="#605E5C"
                                                                       TextWrapping="Wrap"/>
                                                        </Border>

                                                        <!-- Remediation -->
                                                        <Border Background="#FFF8E5" CornerRadius="4" Padding="12,8"
                                                                Margin="8,0,0,8" BorderBrush="#FFE0A0" BorderThickness="1"
                                                                Visibility="{Binding HasRemediation, Converter={StaticResource BoolToVis}}">
                                                            <StackPanel>
                                                                <TextBlock Text="Recommended Action:" FontSize="11"
                                                                           FontWeight="SemiBold" Foreground="#8A6D3B"
                                                                           Margin="0,0,0,4"/>
                                                                <TextBlock Text="{Binding RemediationText}" FontSize="12"
                                                                           Foreground="#8A6D3B" TextWrapping="Wrap"
                                                                           Visibility="{Binding RemediationText, Converter={StaticResource StringToVis}}"/>
                                                                <Button Content="View documentation →"
                                                                        Command="{Binding OpenRemediationCommand}"
                                                                        Style="{StaticResource LinkButton}"
                                                                        Foreground="#0078D4" Margin="0,6,0,0"
                                                                        Visibility="{Binding RemediationUrl, Converter={StaticResource StringToVis}}"/>
                                                            </StackPanel>
                                                        </Border>
                                                    </StackPanel>
                                                </StackPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Expander>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

                <!-- ═══════════════════════════════════════════════════════════ -->
                <!-- Live Connection Diagnostics                                -->
                <!-- ═══════════════════════════════════════════════════════════ -->
                <Border Margin="0,8,0,0" CornerRadius="8" BorderBrush="#B4D6FA" BorderThickness="1.5"
                        Background="#FAFCFF">
                    <StackPanel>
                        <!-- Section Header -->
                        <Border Background="#E8F1FC" CornerRadius="8,8,0,0" Padding="16,12">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="📡" FontSize="18" Margin="0,0,10,0" VerticalAlignment="Center"/>
                                    <StackPanel>
                                        <TextBlock Text="Live Connection Diagnostics" FontSize="16" FontWeight="SemiBold"
                                                   Foreground="#0058A3"/>
                                        <TextBlock Text="Real-time analysis of your active Cloud PC session"
                                                   FontSize="11" Foreground="#605E5C" Margin="0,2,0,0"/>
                                    </StackPanel>
                                </StackPanel>
                                <TextBlock Grid.Column="1" Text="{Binding LiveSessionCategory.Summary}" FontSize="12"
                                           Foreground="#605E5C" VerticalAlignment="Center"/>
                            </Grid>
                        </Border>

                        <!-- Info bar -->
                        <Border Background="#FFF8E5" Padding="12,8" BorderBrush="#FFE0A0" BorderThickness="0,0,0,1">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ℹ" FontSize="14" Margin="0,0,8,0" VerticalAlignment="Center"
                                           Foreground="#8A6D3B"/>
                                <TextBlock Text="Run this tool while connected to your Cloud PC, or from within the Cloud PC session itself."
                                           FontSize="11" Foreground="#8A6D3B" TextWrapping="Wrap" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Border>

                        <!-- Live Session Test Cards -->
                        <ItemsControl ItemsSource="{Binding LiveSessionCategory.Tests}" Margin="12,8,12,12">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="{x:Type vm:TestResultViewModel}">
                                    <Border Style="{StaticResource CardBorder}" Margin="0,0,0,6">
                                        <StackPanel>
                                            <!-- Main Row -->
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="36"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <!-- Status Icon -->
                                                <Border Grid.Column="0" Width="28" Height="28"
                                                        CornerRadius="14"
                                                        Background="{Binding Status, Converter={StaticResource StatusToBackground}}"
                                                        HorizontalAlignment="Center" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding StatusIcon}"
                                                               FontSize="14" FontWeight="Bold"
                                                               Foreground="{Binding Status, Converter={StaticResource StatusToForeground}}"
                                                               HorizontalAlignment="Center"
                                                               VerticalAlignment="Center"/>
                                                </Border>

                                                <!-- Test Name -->
                                                <StackPanel Grid.Column="1" Margin="8,0,16,0"
                                                            VerticalAlignment="Center">
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock Text="{Binding Name}" FontSize="13"
                                                                   FontWeight="SemiBold" Foreground="#323130"/>
                                                        <TextBlock Text="{Binding Duration}" FontSize="11"
                                                                   Foreground="#8A8886" Margin="8,2,0,0"
                                                                   Visibility="{Binding Duration, Converter={StaticResource StringToVis}}"/>
                                                    </StackPanel>
                                                </StackPanel>

                                                <!-- Result Value -->
                                                <TextBlock Grid.Column="2" Text="{Binding ResultValue}"
                                                           FontSize="12" Foreground="#605E5C"
                                                           VerticalAlignment="Center" Margin="0,0,12,0"/>

                                                <!-- Expand Toggle -->
                                                <ToggleButton Grid.Column="3"
                                                              IsChecked="{Binding IsExpanded}"
                                                              Width="24" Height="24" Cursor="Hand"
                                                              VerticalAlignment="Center">
                                                    <ToggleButton.Template>
                                                        <ControlTemplate TargetType="ToggleButton">
                                                            <Border Background="Transparent">
                                                                <TextBlock x:Name="Arrow" Text="▸"
                                                                           FontSize="12" Foreground="#8A8886"
                                                                           HorizontalAlignment="Center"
                                                                           VerticalAlignment="Center"/>
                                                            </Border>
                                                            <ControlTemplate.Triggers>
                                                                <Trigger Property="IsChecked" Value="True">
                                                                    <Setter TargetName="Arrow" Property="Text" Value="▾"/>
                                                                </Trigger>
                                                                <Trigger Property="IsMouseOver" Value="True">
                                                                    <Setter TargetName="Arrow" Property="Foreground"
                                                                            Value="{StaticResource MicrosoftBlueBrush}"/>
                                                                </Trigger>
                                                            </ControlTemplate.Triggers>
                                                        </ControlTemplate>
                                                    </ToggleButton.Template>
                                                </ToggleButton>
                                            </Grid>

                                            <!-- Expandable Details -->
                                            <StackPanel Visibility="{Binding IsExpanded, Converter={StaticResource BoolToVis}}"
                                                        Margin="36,8,0,0">

                                                <!-- Description -->
                                                <TextBlock Text="{Binding Description}" FontSize="12"
                                                           Foreground="#605E5C" TextWrapping="Wrap"
                                                           Margin="8,0,0,8"/>

                                                <!-- Detailed Info -->
                                                <Border Background="#F9F9F9" CornerRadius="4" Padding="12,8"
                                                        Margin="8,0,0,8"
                                                        Visibility="{Binding HasDetails, Converter={StaticResource BoolToVis}}">
                                                    <TextBlock Text="{Binding DetailedInfo}" FontSize="11"
                                                               FontFamily="Consolas" Foreground="#605E5C"
                                                               TextWrapping="Wrap"/>
                                                </Border>

                                                <!-- Remediation -->
                                                <Border Background="#FFF8E5" CornerRadius="4" Padding="12,8"
                                                        Margin="8,0,0,8" BorderBrush="#FFE0A0" BorderThickness="1"
                                                        Visibility="{Binding HasRemediation, Converter={StaticResource BoolToVis}}">
                                                    <StackPanel>
                                                        <TextBlock Text="Recommended Action:" FontSize="11"
                                                                   FontWeight="SemiBold" Foreground="#8A6D3B"
                                                                   Margin="0,0,0,4"/>
                                                        <TextBlock Text="{Binding RemediationText}" FontSize="12"
                                                                   Foreground="#8A6D3B" TextWrapping="Wrap"
                                                                   Visibility="{Binding RemediationText, Converter={StaticResource StringToVis}}"/>
                                                        <Button Content="View documentation →"
                                                                Command="{Binding OpenRemediationCommand}"
                                                                Style="{StaticResource LinkButton}"
                                                                Foreground="#0078D4" Margin="0,6,0,0"
                                                                Visibility="{Binding RemediationUrl, Converter={StaticResource StringToVis}}"/>
                                                    </StackPanel>
                                                </Border>
                                            </StackPanel>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <!-- Footer -->
        <Border Grid.Row="5" Background="White" BorderBrush="#E1DFDD" BorderThickness="0,1,0,0" Padding="24,8">
            <TextBlock FontSize="11" Foreground="#8A8886" HorizontalAlignment="Center">
                <Run Text="Windows 365 / AVD Network Path Analysis Tool  ·  Phase 1: Physical Device Testing  ·  "/>
                <Run Text="{Binding TotalTests, StringFormat='{}{0} tests configured', Mode=OneWay}"/>
            </TextBlock>
        </Border>
    </Grid>
</Window>
